name: Test & Build

on:
  pull_request:
    branches:
      - main
      - dev
  push:
    branches:
      - main
      - dev

jobs:
  main:
    runs-on: macos-latest

    steps:
      # --------------------------------------------------
      # Checkout
      # --------------------------------------------------
      - name: Clone repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # Java (Android)
      # --------------------------------------------------
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: zulu
          java-version: "18.x"

      # --------------------------------------------------
      # Flutter
      # --------------------------------------------------
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.29.3"
          channel: stable
          architecture: x64

      # --------------------------------------------------
      # Dependencies
      # --------------------------------------------------
      - name: Get Flutter packages
        run: flutter pub get

      - name: Check for lints
        run: flutter analyze

      - name: Run tests
        run: flutter test

      # --------------------------------------------------
      # ANDROID – RELEASE APK
      # --------------------------------------------------
      - name: Build Android APK
        run: flutter build apk --release

      # --------------------------------------------------
      # iOS – CERTIFICATE SETUP
      # --------------------------------------------------
      - name: Install iOS Certificate
        run: |
          mkdir -p ~/certs
          echo "${{ secrets.CICD_IOS_P12_BASE64 }}" | base64 --decode > ~/certs/dist.p12

          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import ~/certs/dist.p12 \
            -k build.keychain \
            -P "${{ secrets.CICD_IOS_P12_PASSWORD }}" \
            -T /usr/bin/codesign

          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain

      # --------------------------------------------------
      # iOS – PROVISIONING PROFILE
      # --------------------------------------------------
      - name: Install Provisioning Profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.CICD_IOS_PROVISION_BASE64 }}" | base64 --decode > profile.mobileprovision
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

      # --------------------------------------------------
      # iOS – BUILD SIGNED IPA
      # --------------------------------------------------
      - name: Build SIGNED IPA
        run: |
          flutter build ipa \
            --release \
            --export-options-plist=ios/ExportOptions.plist

      # --------------------------------------------------
      # PACKAGE IPA
      # --------------------------------------------------
      - name: Compress IPA
        run: |
          cd build/ios/ipa
          tar -czf signed_ipa.tar.gz *.ipa

      # --------------------------------------------------
      # UPLOAD ARTIFACTS
      # --------------------------------------------------
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Releases
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/ios/ipa/signed_ipa.tar.gz

      # --------------------------------------------------
      # EMAIL NOTIFICATION
      # --------------------------------------------------
      - name: Send Email
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Flutter CI/CD: ${{ job.status }}"
          to: ${{ secrets.EMAIL_TO }}
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
          body: |
            CI/CD Build Status: ${{ job.status }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Triggered by: ${{ github.actor }}
