# --------------------------------------------------
# Test & Build Workflow with Auto Increment
# --------------------------------------------------
name: Test & Build

on:
  pull_request:
    branches:
      - main
      - dev
  push:
    branches:
      - main
      - dev

jobs:
  main:
    runs-on: macos-latest

    steps:
      # --------------------------------------------------
      # 1. Checkout & Setup
      # --------------------------------------------------
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: zulu
          java-version: "18.x"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.29.3"
          channel: stable
          architecture: x64

      # --------------------------------------------------
      # 2. Dependencies & Testing (CI)
      # --------------------------------------------------
      - name: Get Flutter packages
        run: flutter pub get

      - name: Check for lints
        run: flutter analyze

      - name: Run tests
        run: flutter test

      # --------------------------------------------------
      # 3. Auto-increment Version & Build Number
      # --------------------------------------------------
      - name: Auto-increment version & build
        id: increment_version
        run: |
          # Read current version from pubspec.yaml
          CURRENT_VERSION=$(grep 'version:' pubspec.yaml | awk '{print $2}')
          CURRENT_BUILD=$(echo $CURRENT_VERSION | cut -d+ -f2)
          CURRENT_VER=$(echo $CURRENT_VERSION | cut -d+ -f1)

          # Increment build number by 1
          NEW_BUILD=$((CURRENT_BUILD + 1))

          # Optionally, auto increment minor version every 100 builds
          MAJOR=$(echo $CURRENT_VER | cut -d. -f1)
          MINOR=$(echo $CURRENT_VER | cut -d. -f2)
          PATCH=$(echo $CURRENT_VER | cut -d. -f3)

          if [ $((NEW_BUILD % 100)) -eq 0 ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          fi

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}+${NEW_BUILD}"

          # Update pubspec.yaml
          sed -i '' "s/^version:.*/version: $NEW_VERSION/" pubspec.yaml

          echo "APP_VERSION=$NEW_VERSION" >> "$GITHUB_ENV"
          echo "BUILD_NUMBER=$NEW_BUILD" >> "$GITHUB_ENV"
          echo "IPA_STATUS=SKIPPED" >> "$GITHUB_ENV"

          echo "Updated version to $NEW_VERSION (build $NEW_BUILD)"

      # --------------------------------------------------
      # 4. iOS Code Signing (CD) - Commented Sections
      # --------------------------------------------------
      # - name: Check P12 Secret Availability
      #   if: github.event_name == 'push'
      #   run: |
      #     if [ -z "${{ secrets.CICD_IOS_P12_BASE64 }}" ]; then
      #       echo "❌ P12 secret is empty"
      #       exit 1
      #     else
      #       echo "✅ P12 secret is available"
      #     fi

      # - name: Install iOS Certificate and Keychain
      #   if: github.event_name == 'push'
      #   run: |
      #     mkdir -p ~/certs
      #     echo "${{ secrets.CICD_IOS_P12_BASE64 }}" | base64 --decode > ~/certs/dist.p12
      #     security create-keychain -p "" build.keychain
      #     security default-keychain -s build.keychain
      #     security unlock-keychain -p "" build.keychain
      #     security import ~/certs/dist.p12 \
      #       -k build.keychain \
      #       -P "${{ secrets.CICD_IOS_P12_PASSWORD }}" \
      #       -T /usr/bin/codesign
      #     security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain

      # - name: Install Provisioning Profile
      #   run: |
      #     mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
      #     echo "${{ secrets.CICD_IOS_PROVISION_BASE64 }}" | base64 --decode > profile.mobileprovision
      #     cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

      # - name: Build SIGNED IPA
      #   id: build_ipa
      #   run: |
      #     flutter build ipa \
      #       --release \
      #       --export-options-plist=ios/ExportOptions.plist
      #     IPA_PATH=$(find build/ios/ipa -name "*.ipa" | head -n 1)
      #     echo "IPA_PATH=$IPA_PATH" >> "$GITHUB_ENV"

      # - name: Setup App Store Connect API Key
      #   if: github.event_name == 'push'
      #   run: |
      #     mkdir -p ~/private_keys
      #     KEY_FILE_PATH="$HOME/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8"
      #     echo "${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}" | base64 --decode > $KEY_FILE_PATH
      #     ls -l $KEY_FILE_PATH
      #     head -n 2 $KEY_FILE_PATH

      # - name: Upload IPA to TestFlight
      #   if: github.event_name == 'push' && success()
      #   run: |
      #     export API_KEY_ID="${{ secrets.APP_STORE_CONNECT_KEY_ID }}"
      #     export API_ISSUER_ID="${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}"
      #     KEY_FILE_PATH="$HOME/private_keys/AuthKey_${API_KEY_ID}.p8"
      #     echo "Uploading $IPA_PATH to App Store Connect..."
      #     if xcrun altool --upload-app \
      #       --file "$IPA_PATH" \
      #       --type "ios" \
      #       --apiKey "$API_KEY_ID" \
      #       --apiIssuer "$API_ISSUER_ID" ; then
      #         echo "IPA_STATUS=UPLOADED" >> "$GITHUB_ENV"
      #     else
      #         echo "IPA_STATUS=FAILED" >> "$GITHUB_ENV"
      #         exit 1
      #     fi
      #     rm $KEY_FILE_PATH

      # --------------------------------------------------
      # 5. Android Keystore Setup
      # --------------------------------------------------
      - name: Setup Android Keystore
        if: github.event_name == 'push'
        run: |
          mkdir -p $GITHUB_WORKSPACE/android/app
          # Decode keystore from Base64 secret
          echo "${{ secrets.CICD_ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > $GITHUB_WORKSPACE/android/app/my-release-key.jks
          # Create key.properties for Gradle signing
          cat > $GITHUB_WORKSPACE/android/app/key.properties <<EOL
          storePassword=${{ secrets.CICD_ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.CICD_ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.CICD_ANDROID_KEY_ALIAS }}
          storeFile=$GITHUB_WORKSPACE/android/app/my-release-key.jks
          EOL
          echo "Android keystore and key.properties created."

      # --------------------------------------------------
      # 6. Build APK & AAB
      # --------------------------------------------------
      - name: Build APK & AAB
        run: |
          flutter build apk --release
          flutter build appbundle --release

          APK_PATH=$(find build/app/outputs/flutter-apk -name "*.apk" | head -n 1)
          AAB_PATH=$(find build/app/outputs/bundle/release -name "*.aab" | head -n 1)

          echo "APK_PATH=$APK_PATH" >> "$GITHUB_ENV"
          echo "AAB_PATH=$AAB_PATH" >> "$GITHUB_ENV"
          echo "APK_STATUS=BUILT" >> "$GITHUB_ENV"
          echo "AAB_STATUS=BUILT" >> "$GITHUB_ENV"

      # --------------------------------------------------
      # 7. Upload to Google Play Internal Testing
      # --------------------------------------------------
      - name: Upload to Google Play Internal
        uses: r0adkll/upload-google-play@v1
        if: github.event_name == 'push' && success()
        with:
          serviceAccountJson: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.yourcompany.yourapp
          releaseFiles: ${{ env.AAB_PATH }}
          track: internal

      # --------------------------------------------------
      # 8. Upload Artifacts
      # --------------------------------------------------
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Releases
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            # iOS IPA would go here if needed: build/ios/ipa/*.ipa

      # --------------------------------------------------
      # 9. Send Email Notification
      # --------------------------------------------------
      - name: Send Email
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Flutter CI/CD: ${{ job.status }} - Version ${{ env.APP_VERSION }} (${{ env.BUILD_NUMBER }})"
          to: ${{ secrets.EMAIL_TO }}
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
          body: |
            CI/CD Build Status: ${{ job.status }}
            ---
            Android Deployment Details
            ---
            * Version: ${{ env.APP_VERSION }}
            * Build: ${{ env.BUILD_NUMBER }}
            * APK Status: ${{ env.APK_STATUS }}
            * AAB Status: ${{ env.AAB_STATUS }}
            ---
            Workflow Info
            ---
            * Branch: ${{ github.ref }}
            * Commit: ${{ github.sha }}
            * Triggered by: ${{ github.actor }}
